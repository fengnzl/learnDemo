name: Zhipu PR Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [master, main]

permissions:
  contents: read
  pull-requests: write

jobs:
  zhipu-review:
    name: Zhipu AI Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          separator: ' '

      - name: Get PR diff
        id: diff
        run: |
          DIFF=$(git diff origin/${{ github.base_ref }}...HEAD --diff-filter=M -- '*.ts' '*.tsx' '*.js' '*.jsx' '*.py' '*.go' '*.java' '*.rs' '*.rb' '*.php' '*.cs' '*.cpp' '*.c' '*.h' '*.vue' '*.scss' '*.css' || echo "")
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Prepare review prompt
        id: prompt
        run: |
          cat > /tmp/review_prompt.txt << 'EOF'
          è¯·å®¡æŸ¥ä»¥ä¸‹ Pull Request çš„ä»£ç å˜æ›´ï¼Œé‡ç‚¹å…³æ³¨ï¼š
          1. ä»£ç è´¨é‡ä¸æœ€ä½³å®è·µ
          2. æ½œåœ¨çš„ Bug æˆ–é€»è¾‘é”™è¯¯
          3. å®‰å…¨é—®é¢˜ï¼ˆå¦‚ SQL æ³¨å…¥ã€XSSã€æƒé™æ£€æŸ¥ç­‰ï¼‰
          4. æ€§èƒ½é—®é¢˜
          5. ä»£ç å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§
          6. æ˜¯å¦æœ‰é—æ¼çš„é”™è¯¯å¤„ç†

          è¯·æä¾›å…·ä½“çš„æ”¹è¿›å»ºè®®ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
          ## ğŸ” PR å®¡æŸ¥æŠ¥å‘Š

          ### ğŸ“Š æ•´ä½“è¯„ä»·
          [ç®€è¦æ€»ç»“ä»£ç è´¨é‡ï¼Œ1-2å¥è¯]

          ### ğŸš¨ ä¸¥é‡é—®é¢˜ï¼ˆå¿…é¡»ä¿®å¤ï¼‰
          - [å¦‚æœ‰ä¸¥é‡é—®é¢˜åˆ—å‡º]

          ### âš ï¸ å»ºè®®æ”¹è¿›ï¼ˆåº”è¯¥ä¿®å¤ï¼‰
          - [å¦‚æœ‰å»ºè®®åˆ—å‡º]

          ### ğŸ’¡ ä¼˜åŒ–æç¤ºï¼ˆå¯é€‰ï¼‰
          - [å¦‚æœ‰ä¼˜åŒ–å»ºè®®åˆ—å‡º]

          ### âœ… ä¼˜ç‚¹
          - [åˆ—å‡ºä»£ç ä¸­çš„äº®ç‚¹]

          ---
          PR æ ‡é¢˜: ${{ github.event.pull_request.title }}
          PR æè¿°: ${{ github.event.pull_request.body || '(æ— æè¿°)' }}
          å˜æ›´æ–‡ä»¶: ${{ steps.changed-files.outputs.all_changed_files }}
          PR ä½œè€…: @${{ github.event.pull_request.user.login }}

          ä»£ç å·®å¼‚:
          EOF
          cat /tmp/review_prompt.txt >> $GITHUB_OUTPUT_PATH
          echo "${{ steps.diff.outputs.diff }}" >> $GITHUB_OUTPUT_PATH
        env:
          GITHUB_OUTPUT_PATH: /tmp/full_prompt.txt

      - name: Review with Zhipu AI
        id: review
        run: |
          PROMPT=$(cat /tmp/full_prompt.txt)

          RESPONSE=$(curl -s https://open.bigmodel.cn/api/paas/v4/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.ZHIPU_API_KEY }}" \
            -d '{
              "model": "glm-4-plus",
              "messages": [
                {
                  "role": "user",
                  "content": '"$(echo "$PROMPT" | jq -Rs .)"'
                }
              ],
              "temperature": 0.3,
              "max_tokens": 4096,
              "top_p": 0.9
            }')

          echo "Response: $RESPONSE" >&2

          REVIEW_CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // "å®¡æŸ¥å¤±è´¥: APIè¿”å›é”™è¯¯"')

          # å°†ç»“æœä¿å­˜åˆ°æ–‡ä»¶ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’
          echo "$REVIEW_CONTENT" > /tmp/review_result.txt

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewOutput = fs.readFileSync('/tmp/review_result.txt', 'utf8');

            // æ·»åŠ è¯„è®ºå¤´éƒ¨
            const commentBody = `### ğŸ¤– æ™ºè°± AI ä»£ç å®¡æŸ¥\n\n${reviewOutput}\n\n---\n*æ­¤è¯„è®ºç”± [Zhipu PR Review](.github/workflows/claude_pr_review.yml) è‡ªåŠ¨ç”Ÿæˆ*`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });

      - name: Handle failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '### âš ï¸ ä»£ç å®¡æŸ¥å¤±è´¥\n\nå®¡æŸ¥å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ã€‚'
            });
